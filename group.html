<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Tutoring | Splice Education</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/form.css">
    <script src="https://www.google.com/recaptcha/api.js?render=6LdVB1QsAAAAAPy1d_7Z-j8Iej3arnan-SpJ8GcT"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Group Tutoring</h1>
        <p class="subtitle">Fill out this quick form to join a group tutoring session</p>
      </header>
      <div class="progress-wrapper">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Question 1 of 6</div>
      </div>
      <form id="tutoringForm" action="https://formspree.io/f/xzdekpvv" method="POST">
        <input type="hidden" name="g-recaptcha-response" id="recaptchaToken">
        <div class="card-wrapper">
          <div class="card active">
            <label for="name">Full Name</label>
            <input type="text" id="name" name="name" placeholder="e.g. John Doe" autocomplete="name" required>
          </div>
        </div>
        <input type="text" name="_gotcha" style="display:none">
        <div class="card-wrapper">
          <div class="card">
            <label for="email">Email Address</label>
            <input type="email" id="email" name="email" placeholder="e.g. john@email.com" autocomplete="email" required>
          </div>
        </div>
        <div class="card-wrapper">
          <div class="card">
            <label for="phone">Phone Number</label>
            <input
              type="tel"
              id="phone"
              name="phone"
              placeholder="e.g. 0412 345 678"
              autocomplete="tel"
              required
            >
          </div>
        </div>    
        <div class="card-wrapper">
          <div class="card year-card">
            <label>Student Year Level</label>
        
            <input type="hidden" name="grade" id="gradeValue" required>
        
            <div class="day-selector year-selector">
              <div class="selected-day" id="selectedYear">
                <span id="currentYear">Select year level</span>
                <button type="button" id="toggleYears">&#9662;</button>
              </div>
        
              <div class="day-list" id="yearList">
                <div class="day-option" data-year="Kindergarten">Kindergarten</div>
                <div class="day-option" data-year="Year 1">Year 1</div>
                <div class="day-option" data-year="Year 2">Year 2</div>
                <div class="day-option" data-year="Year 3">Year 3</div>
                <div class="day-option" data-year="Year 4">Year 4</div>
                <div class="day-option" data-year="Year 5">Year 5</div>
                <div class="day-option" data-year="Year 6">Year 6</div>
                <div class="day-option" data-year="Year 7">Year 7</div>
                <div class="day-option" data-year="Year 8">Year 8</div>
                <div class="day-option" data-year="Year 9">Year 9</div>
                <div class="day-option" data-year="Year 10">Year 10</div>
                <div class="day-option" data-year="Year 11">Year 11</div>
                <div class="day-option" data-year="Year 12">Year 12</div>
              </div>
            </div>
          </div>
        </div>    
        <div class="card-wrapper">
          <div class="card">
            <label>How many students are in your group?</label>
            <div class="format-buttons">
              <input type="radio" id="group3" name="groupSize" value="3 Students" required>
              <label for="group3">3</label>
              <input type="radio" id="group4" name="groupSize" value="4 Students">
              <label for="group4">4</label>
              <input type="radio" id="group5" name="groupSize" value="5 Students">
              <label for="group5">5</label>
            </div>
          </div>
        </div>
        <div class="card-wrapper">
          <div class="card">
            <label>Preferred Group Format</label>
            <div class="format-buttons">
              <input type="radio" id="online" name="sessionFormat" value="Online" required>
              <label for="online">Online</label>
              <input type="radio" id="inperson" name="sessionFormat" value="In-Person">
              <label for="inperson">In-Person</label>
              <input type="radio" id="hybrid" name="sessionFormat" value="Hybrid">
              <label for="hybrid">Hybrid</label>
            </div>
          </div>
        </div>
        <div class="card-wrapper">
          <div class="card availability-card">
            <label>Availability</label>
            <p> Note: Group sessions run for 1 hour and 30 minutes. <br><br>Select the time ranges your group is available within for tutoring: </p>
            <div class="availability-container">
              <div class="day-selector">
                <div class="selected-day" id="selectedDay">
                  <span id="currentDay">Monday</span>
                  <button type="button" id="toggleDays">&#9662;</button>
                </div>
                <div class="day-list" id="dayList">
                  <div class="day-option" data-day="Monday">Monday</div>
                  <div class="day-option" data-day="Tuesday">Tuesday</div>
                  <div class="day-option" data-day="Wednesday">Wednesday</div>
                  <div class="day-option" data-day="Thursday">Thursday</div>
                  <div class="day-option" data-day="Friday">Friday</div>
                  <div class="day-option" data-day="Saturday">Saturday</div>
                  <div class="day-option" data-day="Sunday">Sunday</div>
                </div>
                <div class="time-legend">
                  <div><span>Morning:</span><span>9:00am – 12:00pm</span></div>
                  <div><span>Afternoon:</span><span>12:00pm – 5:00pm</span></div>
                  <div><span>Night:</span><span>5:00pm – 9:00pm</span></div>
                </div>
              </div>
              <div class="time-buttons-container"></div>
            </div>
            <div id="availabilitySummary"></div>
          </div>
        </div>
        <div class="card-wrapper">
          <div class="card">
            <label for="comments">(Optional) Group Preferences / Notes</label>
            <textarea id="comments" name="comments" rows="4" placeholder="Friends joining, subject focus, or other group preferences..."></textarea>
          </div>
        </div>
        <input type="text" name="company" tabindex="-1" autocomplete="off" style="display:none">
        <div class="buttons" id="formButtons">
          <button type="button" id="nextBtn">Next</button>
        </div>
      </form>
      <div id="secondaryNav">
        <a href="tutoring.html" class="back-link">← Back to Tutoring Options</a>
      </div>
    </div>
  <script>
    /* ================= HELPERS ================= */

    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    const isValidPhone = phone =>
    /^[0-9+\s()-]{8,}$/.test(phone);

    const isValidEmail = email =>
      /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email);

    /* ================= ELEMENTS ================= */

    const cardWrappers = [...$$('.card-wrapper')];
    const cards = cardWrappers.map(w => w.querySelector('.card'));

    const nextBtn = $('#nextBtn');
    const buttons = $('#formButtons');
    const secondaryNav = $('#secondaryNav');
    const form = $('#tutoringForm');
    const progressFill = $('#progressFill');
    const progressText = $('#progressText');

    let index = 0;
    let submitting = false;

    /* ================= INIT ================= */

    cardWrappers.forEach(w => {
      w.classList.remove('active', 'animate-in');
    });

    const firstWrapper = cardWrappers[0];
    firstWrapper.classList.add('active');

    // force reflow so animation triggers
    void firstWrapper.offsetWidth;

    firstWrapper.classList.add('animate-in');



    /* ================= UI ================= */

    function updateButtons() {
      nextBtn.textContent =
        index === cards.length - 1 ? 'Submit' : 'Next';

      if (index === cards.length - 1) {
        document.body.classList.add('final-step');
      }
    }

    function updateProgress() {
      const total = cards.length;
    const percent = (index  / total) * 100;

      progressFill.style.width = `${percent}%`;
      progressText.textContent = `Question ${Math.min(index + 1, total)} of ${total}`;
    }

    updateButtons();
    updateProgress();

    /* ================= VALIDATION ================= */

    function showError(container, message) {
      let error = container.querySelector('.error-message');
      if (!error) {
        error = document.createElement('div');
        error.className = 'error-message';
        container.appendChild(error);
      }
      error.textContent = message;
    }

    function validateCard(card) {
      let valid = true;
      card.classList.remove('invalid');
      card.removeAttribute('aria-invalid');

      card.querySelector('.error-message')?.remove();

      const textInputs = card.querySelectorAll(
        'input[type="text"], input[type="email"], input[type="tel"]'
      );

      textInputs.forEach(input => {
        if (!input.value.trim()) {
          valid = false;
          showError(card, 'This field is required.');
        } else if (input.type === 'email' && !isValidEmail(input.value)) {
          valid = false;
          showError(card, 'Please enter a valid email address.');
        } else if (input.type === 'tel' && !isValidPhone(input.value)) {
          valid = false;
          showError(card, 'Please enter a valid phone number.');
        }
      });

      const radios = [...card.querySelectorAll('input[type="radio"]')];
      if (radios.length && !radios.some(r => r.checked)) {
        valid = false;
        showError(card, 'Please select an option.');
      }

      if (card.classList.contains('availability-card')) {
        const checks = [...card.querySelectorAll('input[type="checkbox"]')];
        if (!checks.some(c => c.checked)) {
          valid = false;
          showError(card, 'Please select at least one time slot.');
        }
      }
      
      const hiddenRequired = card.querySelector('input[type="hidden"][required]');
      if (hiddenRequired && !hiddenRequired.value) {
        valid = false;
        showError(card, 'Please select a year level.');
      }


      if (!valid) {
        card.classList.add('invalid');
        card.setAttribute('aria-invalid', 'true');
        shakeCard(card);
      }

      return valid;

      }

      function shakeCard(card) {
        card.classList.remove('shake');
        void card.offsetWidth; // force reflow
        card.classList.add('shake');
      }


      /* ================= NAV ================= */

      function scrollToCard(card) {
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            const rect = card.getBoundingClientRect();
            const cardCenter = rect.top + rect.height / 2;
            const viewportCenter = window.innerHeight / 2;

            const offset = cardCenter - viewportCenter;

            window.scrollTo({
              top: window.scrollY + offset,
              behavior: 'smooth'
            });
          });
        });
      }

      function next() {
        let allValid = true;

        // Validate ALL cards up to the current one
        for (let i = 0; i <= index; i++) {
          const valid = validateCard(cards[i]);
          if (!valid) allValid = false;
        }

        if (!allValid) {
          // Scroll to the first invalid card
          const firstInvalid = document.querySelector('.card.invalid');
          if (firstInvalid) scrollToCard(firstInvalid);
          return;
        }

        if (index === cards.length - 1) {
          submitWithRecaptcha();
          return;
        }

        index++;
        updateProgress();
        updateButtons();
        const wrapper = cardWrappers[index];
        const card = cards[index];
        wrapper.classList.add('active');
        card.classList.add('active');


        // force reflow so animation always plays
        void wrapper.offsetWidth;

        wrapper.classList.add('animate-in');

        scrollToCard(card);

      }


      nextBtn.addEventListener('click', next);

      /* ================= ENTER KEY ================= */

      form.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !(e.target.tagName === 'TEXTAREA' && e.shiftKey)) {
          e.preventDefault();
          next();
        }
      });

      /* ================= AVAILABILITY ================= */

      const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
      const timePeriods = ['Morning', 'Afternoon', 'Night'];
      const container = $('.time-buttons-container');

      days.forEach(day => {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'time-buttons day-times';
        dayDiv.dataset.day = day;

        timePeriods.forEach(period => {
          const id = `${day}-${period}`.replace(/[^a-z0-9]/gi, '');

          dayDiv.insertAdjacentHTML('beforeend', `
            <input
              type="checkbox"
              id="${id}"
              name="availability[]"
              value="${day} ${period}"
            >
            <label for="${id}">${period}</label>
          `);
        });

        container.appendChild(dayDiv);
      });


      /* ================= DAY SELECTOR ================= */

      const currentDay = $('#currentDay');
      const dayList = $('#dayList');
      const dayTimes = $$('.day-times');

      dayTimes.forEach(d => d.classList.toggle('active', d.dataset.day === 'Monday'));

      const selectedDay = $('#selectedDay');

      selectedDay.onclick = e => {
        e.stopPropagation();
        dayList.style.display =
          dayList.style.display === 'block' ? 'none' : 'block';
      };


      $$('.day-option').forEach(opt => {
        opt.tabIndex = 0;
        opt.onclick = () => {
          currentDay.textContent = opt.dataset.day;
          dayTimes.forEach(d =>
            d.classList.toggle('active', d.dataset.day === opt.dataset.day)
          );
          dayList.style.display = 'none';
        };
      });

      /* ================= YEAR SELECTOR ================= */

      const currentYear = document.getElementById('currentYear');
      const yearList = document.getElementById('yearList');
      const gradeValue = document.getElementById('gradeValue');
      const selectedYear = document.getElementById('selectedYear');
      const toggleYears = document.getElementById('toggleYears');

      /* move dropdown to body so it escapes stacking contexts */
      document.body.appendChild(yearList);

      yearList.style.position = 'fixed';
      yearList.style.zIndex = '2147483647'; // max safe z-index
      yearList.style.display = 'none';

      function openYearDropdown() {
        const rect = selectedYear.getBoundingClientRect();

        yearList.style.left = rect.left + 'px';
        yearList.style.top = rect.bottom + 'px';
        yearList.style.width = rect.width + 'px';
        yearList.style.display = 'block';
      }

      function closeYearDropdown() {
        yearList.style.display = 'none';
      }

      selectedYear.onclick = e => {
        e.stopPropagation();

        if (yearList.style.display === 'block') {
          closeYearDropdown();
        } else {
          openYearDropdown();
        }
      };

      document.querySelectorAll('#yearList .day-option').forEach(opt => {
        opt.tabIndex = 0;
        opt.onclick = () => {
          const year = opt.dataset.year;
          currentYear.textContent = year;
          gradeValue.value = year;
          closeYearDropdown();
        };
      });

      /* close on outside click */
      document.addEventListener('click', e => {
        if (!yearList.contains(e.target) && !selectedYear.contains(e.target)) {
          closeYearDropdown();
        }
      });

      /* reposition on scroll/resize */
      window.addEventListener('scroll', () => {
        if (yearList.style.display === 'block') openYearDropdown();
      }, true);

      window.addEventListener('resize', () => {
        if (yearList.style.display === 'block') openYearDropdown();
      });


      /* ================= SUMMARY ================= */

      const summary = $('#availabilitySummary');
      const availabilityInputs = $$('input[name="availability[]"]');

      function updateSummary() {
        const map = {};

        availabilityInputs.forEach(cb => {
          if (cb.checked) {
            const [day, time] = cb.value.split(' ', 2);
            (map[day] ||= []).push(time);
          }
        });

        summary.innerHTML = Object.keys(map).length
          ? days.filter(d => map[d]).map(d => `
              <div class="summary-line">
                <span class="day-name">${d}:</span>
                <span>${map[d].join(', ')}</span>
              </div>
            `).join('')
          : '<div>No times selected yet.</div>';
      }

      availabilityInputs.forEach(cb =>
        cb.addEventListener('change', updateSummary)
      );

      updateSummary();

      /* ================= RECAPTCHA ================= */

      function submitWithRecaptcha() {
        if (submitting) return;
        submitting = true;
        nextBtn.disabled = true;

        grecaptcha.ready(() => {
          grecaptcha.execute('6LdVB1QsAAAAAPy1d_7Z-j8Iej3arnan-SpJ8GcT', { action:'submit' })
            .then(token => {
              $('#recaptchaToken').value = token;
              form.submit();
            }); 
        });
      }

      /* =============== CUSTOM LEAVE MODAL ================ */
      document.addEventListener('DOMContentLoaded', () => {

        let formTouched = false;
        let formSubmitted = false;
        let pendingNavigation = null;

        const modal = document.getElementById('leaveModal');
        const stayBtn = document.getElementById('stayBtn');
        const leaveBtn = document.getElementById('leaveBtn');

        // Track dirty state
        form.addEventListener('input', () => {
          if (!formTouched) {
            formTouched = true;
            history.pushState({ dirty: true }, '');
          }
        });

        form.addEventListener('change', () => {
          if (!formTouched) {
            formTouched = true;
            history.pushState({ dirty: true }, '');
          }
        });

        form.addEventListener('submit', () => {
          formSubmitted = true;
        });

        function openModal(onLeave) {
          pendingNavigation = onLeave;
          modal.classList.add('active');
        }

        function closeModal() {
          modal.classList.remove('active');
          pendingNavigation = null;
        }

        stayBtn.addEventListener('click', closeModal);

        leaveBtn.addEventListener('click', () => {
          modal.classList.remove('active');
          if (pendingNavigation) pendingNavigation();
        });

        document.querySelectorAll('a[href]').forEach(link => {
          link.addEventListener('click', e => {
            if (!formTouched || formSubmitted) return;

            e.preventDefault();

            openModal(() => {
              window.location.href = link.href;
            });
          });
        });

        window.addEventListener('popstate', () => {
          if (!formTouched || formSubmitted) return;

          openModal(() => {
            formTouched = false;
            history.back();
          });

          history.pushState({ dirty: true }, '');
        });

      });
    </script>
    <div id="leaveModal" class="modal-overlay">
      <div class="modal">
        <h2>Leave this form?</h2>
        <p>You have unsaved changes. If you leave now, your progress will be lost.</p>
        <div class="modal-actions">
          <button id="stayBtn">Stay</button>
          <button id="leaveBtn" class="danger">Leave</button>
        </div>
      </div>
    </div>
  </body>
</html>